{% load static %}

<style>
    .post
    {
        border: 1px solid black;
        padding: 20px;
        margin-top: 50px;
        border-radius: 15px;
    }


    .post_author_photo
    {
        width: 50px;
        height: 50px;
        border-radius: 25px;
    }

    .post_author
    {
        color: black;
        font-size: 20px;
    }

    .post_published
    {
        float:right;
        text-decoration: none;
        color: black;
    }

    .post_content
    {
        margin-bottom: 20px;
    }

    .post_content_text
    {
        margin-left: 30px;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .post_content_photo
    {
        text-align: center;
    }

    .post_content_photo img
    {
        width: 80%;
        height: 30%;
    }

    .btn
    {
        width: 100px;
    }

    .post_stats a
    {
        color: black;
        text-decoration: none;
    }

</style>

{% for post in posts %}
    <div class="post">
        <div class="post_header">
            <a class="post_author" href="/profile/{{post.author.username}}">
                <img class="post_author_photo" src='{{post.author.photo.url}}'>
                {{post.author.username}}
            </a>
            <a class="post_published">{{post.published}}</a>
            
        </div>
        <div class="post_content">
            <div class="post_content_text">
                <p>{{post.content}}</p>
            </div>
            {% if post.photo %}
            <div class="post_content_photo">
                <img src='{{post.photo.url}}'>
            </div>
            {% endif %}
        </div>

        <div class="post_stats">
            <a class="post_stats_likes">Likes: {{post.likes}} </a>
            <a class="post_stats_comments">Comments: {{post.comments}} </a>
        </div>
        <div class="post_like">
            {% if post.is_liked %}
            <button class="btn btn-danger like_unlike_btn" id={{post.id}}>Unlike</button>
            {% else %}
            <button class="btn btn-primary like_unlike_btn" id={{post.id}}>Like</button>
            {% endif %}
        </div>
    </div>
{% endfor %}

<script>
    $('.like_unlike_btn').click(function(event) {
        let target = $(this);
        let mode = $(event.target).text();
        let url = mode == "Like" ? "{% url 'like_url' %}" : "{% url 'unlike_url' %}";
        let likes = $(event.target).parent().parent().find(".post_stats_likes")[0];

        $.ajax({
               type: "POST",
               url: url,
               data: {'post_id': target.attr("id"), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
               dataType: "json",
               success: function(response) {
                    if (mode == "Like")
                    {
                        target.text("Unlike");
                        target.removeClass('btn-primary');
                        target.addClass("btn-danger");
                        
                    }
                    else
                    {
                        target.text("Like")
                        target.removeClass('btn-danger');
                        target.addClass("btn-primary");
                    }
                    likes.innerHTML = "Likes: " + response.post_likes.toString();
                },
                error: function(response, e) {
                       console.log(response.responseText);
                }
          }); 
    })
</script>